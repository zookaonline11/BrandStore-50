// Simple Brand Store JS for "brand store-50"
// Usage: include this script after your HTML elements (or run init() on DOMContentLoaded)

// Sample data (replace with fetch from API if needed)
const PRODUCTS = [
  { id: 'p1', name: 'Classic Tee', brand: 'Brand A', price: 25.0, image: '', category: 'Apparel', stock: 10, description: 'Comfortable cotton tee.' },
  { id: 'p2', name: 'Leather Wallet', brand: 'Brand B', price: 45.0, image: '', category: 'Accessories', stock: 5, description: 'Genuine leather wallet.' },
  { id: 'p3', name: 'Running Shoes', brand: 'Brand C', price: 85.5, image: '', category: 'Footwear', stock: 7, description: 'Lightweight running shoes.' },
  { id: 'p4', name: 'Denim Jacket', brand: 'Brand A', price: 120.0, image: '', category: 'Apparel', stock: 3, description: 'Stylish denim jacket.' },
  { id: 'p5', name: 'Sunglasses', brand: 'Brand D', price: 60.0, image: '', category: 'Accessories', stock: 15, description: 'UV protection sunglasses.' }
];

// Config
const CART_KEY = 'brandstore50_cart';

// Utilities
function formatCurrency(n) {
  return '$' + n.toFixed(2);
}

function saveCart(cart) {
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
}

function loadCart() {
  try {
    const raw = localStorage.getItem(CART_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}

function debounce(fn, ms = 300) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
}

// Cart logic
const Cart = {
  items: loadCart(), // { productId: qty }
  add(productId, qty = 1) {
    const product = PRODUCTS.find(p => p.id === productId);
    if (!product) return false;
    const current = this.items[productId] || 0;
    if (current + qty > product.stock) {
      return false; // cannot exceed stock
    }
    this.items[productId] = current + qty;
    saveCart(this.items);
    renderCart(); // update UI
    renderCartCount();
    return true;
  },
  remove(productId) {
    delete this.items[productId];
    saveCart(this.items);
    renderCart();
    renderCartCount();
  },
  update(productId, qty) {
    const product = PRODUCTS.find(p => p.id === productId);
    if (!product) return false;
    if (qty <= 0) {
      this.remove(productId);
      return true;
    }
    if (qty > product.stock) return false;
    this.items[productId] = qty;
    saveCart(this.items);
    renderCart();
    renderCartCount();
    return true;
  },
  clear() {
    this.items = {};
    saveCart(this.items);
    renderCart();
    renderCartCount();
  },
  total() {
    return Object.entries(this.items).reduce((sum, [pid, qty]) => {
      const p = PRODUCTS.find(x => x.id === pid);
      return sum + (p ? p.price * qty : 0);
    }, 0);
  },
  count() {
    return Object.values(this.items).reduce((a, b) => a + b, 0);
  }
};

// Rendering
function renderProducts({ containerId = 'products', products = PRODUCTS } = {}) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  if (!products.length) {
    container.innerHTML = '<p>No products found.</p>';
    return;
  }
  const frag = document.createDocumentFragment();
  products.forEach(p => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <div class="product-image">${p.image ? `<img src="${p.image}" alt="${p.name}">` : '<div class="placeholder-image">No Image</div>'}</div>
      <div class="product-body">
        <h3 class="product-name">${escapeHtml(p.name)}</h3>
        <p class="product-brand">${escapeHtml(p.brand)} • ${escapeHtml(p.category)}</p>
        <p class="product-desc">${escapeHtml(p.description)}</p>
        <div class="product-meta">
          <span class="price">${formatCurrency(p.price)}</span>
          <span class="stock">${p.stock} in stock</span>
        </div>
        <div class="product-actions">
          <input type="number" min="1" max="${p.stock}" value="1" class="qty-input" aria-label="Quantity for ${escapeHtml(p.name)}" />
          <button class="add-btn" data-id="${p.id}">Add to Cart</button>
        </div>
      </div>
    `;
    frag.appendChild(card);
  });
  container.appendChild(frag);

  // wire up add buttons
  container.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      const card = e.currentTarget.closest('.product-card');
      const qtyInput = card.querySelector('.qty-input');
      const qty = Math.max(1, Math.min(parseInt(qtyInput.value, 10) || 1, PRODUCTS.find(p => p.id === id).stock));
      const ok = Cart.add(id, qty);
      if (!ok) {
        alert('Cannot add more than available stock.');
      }
    });
  });
}

function renderCart({ containerId = 'cart' } = {}) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  const keys = Object.keys(Cart.items);
  if (!keys.length) {
    container.innerHTML = '<p>Your cart is empty.</p>';
    return;
  }
  const ul = document.createElement('ul');
  ul.className = 'cart-list';
  keys.forEach(pid => {
    const qty = Cart.items[pid];
    const p = PRODUCTS.find(x => x.id === pid);
    if (!p) return;
    const li = document.createElement('li');
    li.className = 'cart-item';
    li.innerHTML = `
      <div class="cart-left">
        <strong>${escapeHtml(p.name)}</strong>
        <div class="small">${escapeHtml(p.brand)} • ${escapeHtml(p.category)}</div>
      </div>
      <div class="cart-right">
        <div>${formatCurrency(p.price)} x
          <input type="number" min="1" max="${p.stock}" value="${qty}" data-pid="${pid}" class="cart-qty" />
        </div>
        <div class="cart-line-total">${formatCurrency(p.price * qty)}</div>
        <button class="remove-btn" data-pid="${pid}">Remove</button>
      </div>
    `;
    ul.appendChild(li);
  });
  const totalDiv = document.createElement('div');
  totalDiv.className = 'cart-total';
  totalDiv.innerHTML = `<strong>Total: ${formatCurrency(Cart.total())}</strong>`;
  container.appendChild(ul);
  container.appendChild(totalDiv);

  // wire events
  container.querySelectorAll('.remove-btn').forEach(b => {
    b.addEventListener('click', () => {
      Cart.remove(b.dataset.pid);
    });
  });
  container.querySelectorAll('.cart-qty').forEach(input => {
    input.addEventListener('change', (e) => {
      const pid = e.target.dataset.pid;
      const v = parseInt(e.target.value, 10) || 1;
      const ok = Cart.update(pid, v);
      if (!ok) {
        alert('Invalid quantity (exceeds stock).');
        renderCart(); // revert
      }
    });
  });
}

function renderCartCount({ elId = 'cart-count' } = {}) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.textContent = Cart.count();
}

// Filters & search
function getUniqueCategories() {
  const s = new Set(PRODUCTS.map(p => p.category));
  return [...s];
}

function applyFilters({ search = '', category = '', priceMin = 0, priceMax = Infinity, sortBy = '' } = {}) {
  let res = PRODUCTS.slice();
  if (search) {
    const q = search.toLowerCase();
    res = res.filter(p => (p.name + ' ' + p.brand + ' ' + p.description).toLowerCase().includes(q));
  }
  if (category) {
    res = res.filter(p => p.category === category);
  }
  res = res.filter(p => p.price >= priceMin && p.price <= priceMax);
  if (sortBy === 'price-asc') res.sort((a,b)=>a.price-b.price);
  if (sortBy === 'price-desc') res.sort((a,b)=>b.price-a.price);
  if (sortBy === 'name') res.sort((a,b)=>a.name.localeCompare(b.name));
  renderProducts({ products: res });
}

// Small helper to escape text (prevent injection when inserting innerHTML)
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Initialization: wires up basic UI controls if present
function init(options = {}) {
  // render initial products and cart
  renderProducts();
  renderCart();
  renderCartCount();

  // populate category filter if exists
  const catEl = document.getElementById('filter-category');
  if (catEl) {
    catEl.innerHTML = `<option value="">All</option>` + getUniqueCategories().map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    catEl.addEventListener('change', () => {
      const search = document.getElementById('search-input')?.value || '';
      const min = parseFloat(document.getElementById('price-min')?.value || 0) || 0;
      const max = parseFloat(document.getElementById('price-max')?.value || Infinity) || Infinity;
      const sortBy = document.getElementById('sort-by')?.value || '';
      applyFilters({ search, category: catEl.value, priceMin: min, priceMax: max, sortBy });
    });
  }

  const searchEl = document.getElementById('search-input');
  if (searchEl) {
    searchEl.addEventListener('input', debounce(() => {
      const search = searchEl.value;
      const category = document.getElementById('filter-category')?.value || '';
      const min = parseFloat(document.getElementById('price-min')?.value || 0) || 0;
      const max = parseFloat(document.getElementById('price-max')?.value || Infinity) || Infinity;
      const sortBy = document.getElementById('sort-by')?.value || '';
      applyFilters({ search, category, priceMin: min, priceMax: max, sortBy });
    }, 250));
  }

  const sortEl = document.getElementById('sort-by');
  if (sortEl) {
    sortEl.addEventListener('change', () => {
      const search = document.getElementById('search-input')?.value || '';
      const category = document.getElementById('filter-category')?.value || '';
      const min = parseFloat(document.getElementById('price-min')?.value || 0) || 0;
      const max = parseFloat(document.getElementById('price-max')?.value || Infinity) || Infinity;
      applyFilters({ search, category, priceMin: min, priceMax: max, sortBy: sortEl.value });
    });
  }

  const clearBtn = document.getElementById('clear-cart');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear the cart?')) Cart.clear();
    });
  }
}

// Auto-init when DOM ready if not calling manually
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => init());
} else {
  init();
}

// Export for manual control (optional)
window.BrandStore50 = {
  init,
  renderProducts,
  renderCart,
  Cart
};
